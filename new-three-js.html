
<script src="threejs/three.js"></script>
<link rel="import" href="../polymer/polymer.html">

<dom-module id='three-js'>

  <style>
    :host {
      display: block;
      position: relative;
    }
    canvas {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
    }
  </style>

  <template>
      <content></content>
  </template>

  <script>
    Polymer({
      is: 'three-js',
      properties :{
          renderNow: {
              type: Boolean,
              value: false,
              observer: 'renderNowChanged'
          }
      },
      listeners : {
          track: 'track',
          'three-js-get-renderer': 'getRenderer'
      },
      ready: function() {
        var renderer = new THREE.WebGLRenderer({antialias: true});
        console.log(renderer.domElement);
        Polymer.dom(this.root).appendChild(renderer.domElement);
        console.log(renderer.domElement);
        console.log(this.offsetWidth);
        console.log(Polymer.dom(this).parentNode);
        this.renderer = renderer;
        renderer.setSize(500, 500); //FIXME :Don't hardcode this.
        renderer.shadowMapEnabled = true;
        renderer.shadowMapType = THREE.PCFShadowMap;
        this.scene = new THREE.Scene;
        this.invalidate();
        console.log('[%s]: ready', this.localName, this.renderer);
      },
      renderNowChanged: function() {
        this.render();
      },
      invalidate: function() {
        this.validateJob = this.debounce(this.validateJob, this.validate, 250);
      },
      validate: function() {
        (this.validateJob || this.nullJob).stop();
        this.render();
      },
      nullJob: {
        stop: function(){}
      },
      render: function() {
        if (this.camera) {
          console.log(this.scene);
          //this.camera.lookAt(new THREE.Vector3(0,0,0));
          this.renderer.render(this.scene, this.camera);
          console.log("rendered again");
        } else console.log('no camera');
      },
      add3: function(child) {
        if (child.localName === 'three-js-camera') {
          this.camera = child.object;
          this.camera.lookAt(new THREE.Vector3(0,0,0)); //Initial look at to origin.
        }
        this.scene.add(child.object);
        this.invalidate();
      },
      remove3: function(child) {
        this.scene.remove(child.object);
        this.invalidate();
      },
      getRenderer: function(event) {
        event.detail.renderer = this.renderer;
        //return this.renderer;
      },
      //
      track: function(event) {
        var obj = this.camera;
        if (obj) {
          this.render();
        }
      }
    });
  </script>
</dom-module> <!-- CONVERTED -->

<link rel="import" href="three-js-object.html"> <!--The three js object behaviour -->

<dom-module id='three-js-camera'  >

      <style>
      </style>

      <template>
          <content></content>
      </template>
      <script>
        Polymer({
          is: 'three-js-camera',
          properties: {
            lookat: {
              type: String,
              value: ''
            },
            aspect: {
              type: Number,
              value:16 / 9
            },
            fov: {
              type:Number,
              value: 45
            }
          },
          behaviors : [ThreeJSObjectBehaviour],
          object: null,
          ready: function() {
            this.object = new THREE.PerspectiveCamera(this.fov, this.aspect, 0.1, 10000);
          },
          /*updatePosition: function() {
            //this.super(); TODO: Don't think I need this anymore as I'm not inheriting. Do check up anyway.
            this.lookAtChanged();
        },*/
          lookAtChanged: function() {
            var node = Polymer.dom(this).parentNode.querySelector(this.lookAt);
            console.log(node);
            if (node /*&& node.object*/) {
              this.object.lookAt(node);
            }
          },
      });
      </script>
</dom-module> <!-- CONVERTED -->
<dom-module id='three-js-mesh'>

  <style>
  </style>

  <template>
      <content></content>
  </template>

  <script>
    Polymer({
      is: 'three-js-mesh',
      behaviors: [ThreeJSObjectBehaviour],
      ready: function() {
        //this.validate();
        this.observeDOM();
      },
      listeners: {
        'three-js-material-changed': 'doMaterialChanged',
        'three-js-geometry-changed': 'doGeometryChanged'
      },
      observeDOM: function() {
        /*Polymer.dom(this).onMutation(this, function() {
          this.validate();
          this.observeDOM();
      });*/ //FIXME: Use a mutation observer to fix this.
       this.observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if(this.validate){
                    this.validate();
                }
                else {
                    console.log(this);
                    return;
                }
                console.log("Observer worked!");
                //observer.disconnect();
                //this.observeDOM();
          });
        });
        console.log("Mutation being set up!");
        console.log(this);
        this.observer.observe(this,{ childList: true });
        console.log(this.observer);
        //FIXME: This isn't ever getting called.
      },
      validate: function() {
        if (!this.objectParent) {
          if (!this.geometry) {
            var g = Polymer.dom(this).querySelector('three-js-geometry');
            this.geometry = g ? g.object : null;
            console.log("set geometry as");
            console.log(this.geometry);
          }
          if (this.geometry && this.material) {
            //this.removeFromParent3();
            this.object = new THREE.Mesh(this.geometry, this.material);
            console.log("Mesh created");
            console.log(this.object);
            this.addToParent3();
          }
        }
      },
      lightDomReady: function() {
        // TODO: As we are not interiting anymore, add a check in the object behaviour
      },
      doMaterialChanged: function(event, material) {
        this.material = material;
        console.log("doMaterialChanged!");
        this.validate();
        event.stopPropagation();
      },
      doGeometryChanged: function(event, geometry) {
        this.geometry = geometry;
        console.log("doGeomertyChanged!");
        this.validate();
        event.stopPropagation();
      }
    });
  </script>
</dom-module> <!-- CONVERTED -->

<dom-module id='three-js-material'  >

  <style>
  </style>

  <template>
      <content></content>
  </template>

  <script>
    Polymer({
      is: 'three-js-material',
      kinds: {
        basic: 'MeshBasicMaterial',
        lambert: 'MeshLambertMaterial',
        phong: 'MeshPhongMaterial',
        texture: 'texture'
      },
      sides: {
        front: 'FrontSide',
        back: 'BackSide',
        double: 'DoubleSide'
      },
      shadings: {
        flat: 'FlatShading'
      },
      properties: {
          kind: {
              type: String,
          },
          color: {
              type: Number,
              value: 0x1EC876
          },
          side: {
              type: String,
          },
          texture: {
              type: String,
              value: ''
          },
          ambient: {
              type: Number,
              value: 0
          },
          specular: {
              type: Number,
              value: 0
          },
          shine: {
              type: Number,
              value: 30
          },
          object: {
              observer: 'objectChanged'
          }
      },

      attached: function() {
        this.async(function() {
          //console.log('[%s]: lightDomReady', this.localName);
          this.lightDomReady();
        });
      },
      lightDomReady: function() {
        this.init();
        //this.super();
      },
      init: function() {
        var kind = this.kinds[this.kind] || this.kinds.basic;
        var side = this.sides[this.side] || this.sides.front;
        var shading = this.shadings[this.shading] || this.shadings.flat;
        switch (kind) {
          case 'texture':
            var texture = THREE.ImageUtils.loadTexture(this.texture);
            var renderer = this.fire('three-js-get-renderer').detail.renderer; //TODO: Check if this works
            if (renderer) {
              texture.anisotropy = renderer.getMaxAnisotropy();
            } else {
              console.log('no renderer');
            }
            this.object = new THREE.MeshBasicMaterial({map: texture, side: THREE[side]});
            break;
          default:
            this.object = new (THREE[kind])({
              color: this.color,
              side: THREE[side],
              specular: this.specular,
              shininess: this.shine,
              ambient: this.ambient,
              shading: THREE[shading]
            });
            break;
        }
      },
      objectChanged: function() {
        console.log("Fired!");
        this.fire('three-js-material-changed', this.object); //TODO: Make sure this is working. The migration guide does mention some changes.
      }
    });
  </script>
</dom-module> <!-- CONVERTED -->

<dom-module id='three-js-geometry'  >

  <style>
  </style>

  <template>
      <content></content>
  </template>
  <script>
    Polymer({
      is: 'three-js-geometry',
      properties: {
          w: {
              type: Number,
              value:100
              },
          h: {
              type: Number,
              value:100
              },
          d: {
              type: Number,
              value:100
              },
          extent: {
              type: Number,
              value: 0
              },
          object: {
              observer: 'objectChanged'
          }
      },
      attached: function() {
        this.async(function() {
          //console.log('[%s]: lightDomReady', this.localName);
          this.extentChanged();
          this.object = new THREE.BoxGeometry(this.w, this.h, this.d);
          console.log("Geometry created");
          console.log(this.object);
        });
      },
      extentChanged: function() {
        if (this.extent) {
          this.w = this.h = this.d = this.extent;
        }
      },
      objectChanged: function() {
          console.log("Fired Geom!");
          console.log(this.object);
          this.fire('three-js-geometry-changed', this.object); //TODO: Make sure this is working. The migration guide does mention some changes.
      }
    });
  </script>
</dom-module> <!-- CONVERTED -->
