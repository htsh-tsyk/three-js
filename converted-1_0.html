<script src="threejs/three.js"></script>
<link rel="import" href="../polymer/polymer.html">

<dom-module id='three-js' on-three-js-get-renderer="getRenderer">

  <style>
    :host {
      display: block;
      position: class="relative;"   <!-- class="relative;"  // TODO cleanup class= if needed  CONVERTED WIP  -->
    }
    canvas {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
    }
  </style>

  <template>
  </template>

  <script>
    Polymer({
      is: 'three-js',
      properties :{
          renderNow: {
              type: Boolean,
              value: false,
              observer: 'renderNowChanged'
          }
      },
      listeners : {
          track: 'track',
      },
      ready: function() {
        var renderer = new THREE.WebGLRenderer({antialias: true});
        Polymer.dom(this.root).appendChild(renderer.domElement);
        this.renderer = renderer;
        renderer.setSize(this.offsetWidth, this.offsetHeight);
        renderer.shadowMapEnabled = true;
        renderer.shadowMapType = THREE.PCFShadowMap;
        this.scene = new THREE.Scene;
        this.invalidate();
        console.log('[%s]: ready', this.localName, this.renderer);
      },
      renderNowChanged: function() {
        this.render();
      },
      invalidate: function() {
        this.validateJob = this.job(this.validateJob, this.validate, 250);
      },
      validate: function() {
        (this.validateJob || this.nullJob).stop();
        this.render();
      },
      nullJob: {
        stop: function(){}
      },
      render: function() {
        if (this.camera) {
          this.renderer.render(this.scene, this.camera);
        } else console.log('no camera');
      },
      add3: function(child) {
        if (child.localName === 'three-js-camera') {
          this.camera = child.object;
          //console.log(child.object);
        }
        this.scene.add(child.object);
        this.invalidate();
      },
      remove3: function(child) {
        this.scene.remove(child.object);
        this.invalidate();
      },
      getRenderer: function(event) {
        event.detail.renderer = this.renderer;
        //return this.renderer;
      },
      //
      track: function(event) {
        var obj = this.camera;
        var obj = Polymer.dom(this).querySelector('[tracking]').object;
        if (obj) {
          // TODO(sjmiles): accumulating derivatives is numerically unstable
          // integrating samples over a single track sequence is a better practice
          // make this easier to do properly
          obj.position.x += event.ddx;
          obj.position.z += event.ddy;
          this.render();
        }
      }
    });
  </script>
</dom-module> <!-- CONVERTED -->

<script>
ThreeJSObjectBehaviour = {
      properties:{
          x: {
              type: Number,
              value: 0,
              observer: 'updatePosition'
          },
          y: {
              type: Number,
              value: 0,
              observer: 'updatePosition'
          },
          z: {
              type: Number,
              value: 0,
              observer: 'updatePosition'
          },
          rx: {
              type: Number,
              value: 0
          },
          ry: {
              type: Number,
              value: 0
          },
          rz: {
              type: Number,
              value: 0
          },
          castShadow: {
              type: Boolean,
              value: false
          },
          receiveShadow: {
              type: Boolean,
              value: false
          },
          tracking: {
              type: Boolean,
              value: false
          }
      },
      setPosition: function(x, y, z) {
        this.x = x;
        this.y = y;
        this.z = z;
      },
      objectChanged: function() {
        this.updatePosition();
      },
      updatePosition: function() {
        if (this.object) {
          this.object.position.set(Number(this.x), Number(this.y), Number(this.z));
          this.object.rotation.set(this.rx * Math.PI/180, this.ry * Math.PI/180, this.rz * Math.PI/180);
          this.object.castShadow = this.castShadow;
          this.object.receiveShadow = this.receiveShadow;
        }
      },
      /*get position() {
        return {x: this.x, y: this.y, z: this.z};
      },*/
      addToParent3: function() {
        if (this.parentNode.add3 && !this.objectParent) {
          this.objectParent = this.parentNode;
          this.parentNode.add3(this);
          //console.log('[%s]: added to threejs-object parent', this.localName + (this.id ? '#' + this.id : ''));
        }
      },
      removeFromParent3: function() {
        if (this.objectParent) {
          this.objectParent.remove3(this);
          this.objectParent = null;
          //console.log('[%s]: REMOVED from threejs-object parent', this.localName + (this.id ? '#' + this.id : ''));
        }
      },
      attached: function() {
        /*
        var l = '';
        var p = this.parentNode;
        while (p) {
          l += ':' + p.localName;
          p = p.parentNode || p.host;
        }
        console.log('[%s]: attached: parent chain: [%s]', this.localName + (this.id ? '#' + this.id : ''), l);
        */
        this.async(function() {
          //console.log('[%s]: lightDomReady', this.localName);
          this.lightDomReady();
        });
      },
      lightDomReady: function() {
        this.addToParent3();
      },
      detached: function() {
        this.removeFromParent3();
      }
  };
</script>

<dom-module id='three-js-camera'  > <!-- CONVERTED WIP , TODO: determine what to do with: extends="three-js-object" -->

  <style>
  </style> <!-- TODO Move style tags here from <template> if needed CONVERTED WIP -->

  <script>
    Polymer('three-js-camera', {
      is: 'three-js-camera', // CONVERTED WIP
      lookAt: '',
      aspect: 16 / 9,
      fov: 45,
      object: null,
      ready: function() {
        this.object = new THREE.PerspectiveCamera(this.fov, this.aspect, 0.1, 10000);
      },
      updatePosition: function() {
        this.super();
        this.lookAtChanged();
      },
      lookAtChanged: function() {
        var node = this.parentNode.querySelector(this.lookAt);
        if (node /*&& node.object*/) {
          this.object.lookAt(node);
        }
      }
    });
  </script>
</dom-module> <!-- CONVERTED -->

<dom-module id='three-js-light'  > <!-- CONVERTED WIP , TODO: determine what to do with: extends="three-js-object" -->

  <style>
  </style> <!-- TODO Move style tags here from <template> if needed CONVERTED WIP -->

  <script>
    Polymer('three-js-light', {
      is: 'three-js-light', // CONVERTED WIP
      kinds: {
        point: 'PointLight',
        spot: 'SpotLight'
      },
      color: 0xFFFFFF,
      shadow: false,
      intensity: 1,
      distance: 0,
      angle: 60,
      exponent: 8,
      ready: function() {
        var kind = this.kinds[this.kind] || this.kinds.point;
        this.object = new THREE[kind](this.color, this.intensity, this.distance, this.angle * Math.PI/180, this.exponent);
        if (this.shadow) {
          this.object.castShadow = true;
          this.object.shadowMapWidth = 1024;
          this.object.shadowMapHeight = 1024;
          this.object.shadowCameraNear = 500;
          this.object.shadowCameraFar = 4000;
          this.object.shadowCameraFov = 30;
          this.object.shadowBias = 0.0001;
          this.object.shadowDarkness = 0.5;
        }
      },
      updatePosition: function() {
        this.super();
        //console.log('updatePosition:', this.kind, this)
      }
    });
  </script>
</dom-module> <!-- CONVERTED -->

<dom-module id='three-js-mesh'  > <!-- CONVERTED WIP , TODO: determine what to do with: extends="three-js-object" on-three-js-material-changed="{{doMaterialChanged}}" -->

  <style>
  </style> <!-- TODO Move style tags here from <template> if needed CONVERTED WIP -->

  <script>
    Polymer('three-js-mesh', {
      is: 'three-js-mesh', // CONVERTED WIP
      ready: function() {
        //this.validate();
        this.observeDOM();
      },
      observeDOM: function() {
        this.onMutation(this, function() {
          this.validate();
          this.observeDOM();
        });
      },
      validate: function() {
        if (!this.objectParent) {
          if (!this.geometry) {
            var g = this.querySelector('three-js-geometry');
            this.geometry = g ? g.object : null;
          }
          if (this.geometry && this.material) {
            //this.removeFromParent3();
            this.object = new THREE.Mesh(this.geometry, this.material);
            this.addToParent3();
          }
        }
      },
      lightDomReady: function() {
        // stub out super class version, we don't enter the
        // scene graph until our geometry and material are both ready
      },
      doMaterialChanged: function(event, material) {
        this.material = material;
        this.validate();
        event.stopPropagation();
      }
    });
  </script>
</dom-module> <!-- CONVERTED -->

<dom-module id='three-js-material'  > <!-- CONVERTED WIP -->

  <style>
  </style> <!-- TODO Move style tags here from <template> if needed CONVERTED WIP -->

  <script>
    Polymer('three-js-material', {
      is: 'three-js-material', // CONVERTED WIP
      kinds: {
        basic: 'MeshBasicMaterial',
        lambert: 'MeshLambertMaterial',
        phong: 'MeshPhongMaterial',
        texture: 'texture'
      },
      sides: {
        front: 'FrontSide',
        back: 'BackSide',
        double: 'DoubleSide'
      },
      shadings: {
        flat: 'FlatShading'
      },
      //ambient: 0,
      //specular: 0,
      //shininess: 30,
      color: 0x1EC876,
      texture: '',
      attached: function() {
        this.async(function() {
          //console.log('[%s]: lightDomReady', this.localName);
          this.lightDomReady();
        });
      },
      lightDomReady: function() {
        this.init();
        //this.super();
      },
      init: function() {
        var kind = this.kinds[this.kind] || this.kinds.lambert;
        var side = this.sides[this.side] || this.sides.front;
        var shading = this.shadings[this.shading] || this.shadings.flat;
        switch (kind) {
          case 'texture':
            var texture = THREE.ImageUtils.loadTexture(this.texture);
            var renderer = this.fire('three-js-get-renderer').detail.renderer;
            if (renderer) {
              texture.anisotropy = renderer.getMaxAnisotropy();
            } else {
              console.log('no renderer');
            }
            this.object = new THREE.MeshBasicMaterial({map: texture, side: THREE[side]});
            break;
          default:
            this.object = new (THREE[kind])({
              color: this.color,
              side: THREE[side],
              specular: this.specular,
              shininess: this.shine,
              ambient: this.ambient,
              shading: THREE[shading]
            });
            break;
        }
      },
      objectChanged: function() {
        this.fire('three-js-material-changed', this.object);
      }
    });
  </script>
</dom-module> <!-- CONVERTED -->

<dom-module id='three-js-geometry'  > <!-- CONVERTED WIP -->

  <style>
  </style> <!-- TODO Move style tags here from <template> if needed CONVERTED WIP -->

  <script>
    Polymer('three-js-geometry', {
      is: 'three-js-geometry', // CONVERTED WIP
      w: 100,
      h: 100,
      d: 100,
      extent: 0,
      ready: function() {
        this.extentChanged();
        this.object = new THREE.CubeGeometry(this.w, this.h, this.d);
      },
      extentChanged: function() {
        if (this.extent) {
          this.w = this.h = this.d = this.extent;
        }
      }
    });
  </script>
</dom-module> <!-- CONVERTED -->

<dom-module id='three-js-cube' noscript lightdom > <!-- CONVERTED WIP , TODO: determine what to do with: extends="three-js-mesh" -->

  <style>
  </style> <!-- TODO Move style tags here from <template> if needed CONVERTED WIP -->

  <template>
    <three-js-geometry></three-js-geometry>
    <three-js-material kind="lambert" color="{{color}}"></three-js-material>
  </template>
</dom-module> <!-- CONVERTED -->

<!-- prototype chain not supported for second argument to Polymer() -->
                                                            is: 'three-js-cube', // CONVERTED WIP

                                                            properties: {
                                                              //  TODO: add attributes="color" to properites -- CONVERTED WIP
                                                            },

<!--<polymer-element name="real-three-js-light">
  <script>
    (function() {
      var proto = Object.create(THREE.PointLight.prototype);
      proto.ready = function() {
        THREE.PointLight.call(this);
        //console.dir(this);
      }
      Polymer('real-three-js-light', proto);
    })();
  </script>
</dom-module> <!-- CONVERTED -->

<!-- CONVERSION NOTES TODO:
 Review code and look for:
 - textContent binding from <div>First: {{first}}</div> TO First <span>{{first}}</span><br>
 - polymer-element default attributes such as tabindex="0" move to hostAttributes: {  tabindex: 0}
 - custom elements correct JSON quotes required, change from <my-element foo="{ 'title': 'Persuasion', 'author': 'Austen' }"> to </my-element> to <my-element foo="{ "title": "Persuasion", "author": "Austen" }"></my-element>
 - custom elements attribute use dash-case not camelCase, change from  <my-element fooBar= to <my-element foo-bar
 - Polymer( fix mixins use Behaviors after is: see https://www.polymer-project.org/1.0/docs/devguide/behaviors.html
 - Check layout attributes replaced by layout classes <div layout horizontal center>` to `<div class="layout horizontal center">,
 - Cleanup class=
 - Convert core- to iron- or paper- replacement elements at PolymerElements
 - Remove unresolved from <body> tag
 - Cleanup iron-ajax params url for embedded bindings {{}}
 - iron-ajax replace this.$.xxx_ajax.abort(); and this.$.xxx_ajax.go(); with this.$.xxx_ajax.generateRequest()
 - Fix iron-list if needed
 - Fix indentation as need
 - Cleanup Comments to reflect changes ,
 - see https://www.polymer-project.org/1.0/docs/migration.html
   -->
